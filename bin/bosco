#!/usr/bin/env python
# -*- coding: utf-8 -*-
# generated by wxGlade 0.6.3 on Sun May 17 23:10:24 2009

import sys

import wx
import wx.grid
from wx.lib.scrolledpanel import ScrolledPanel
from wx.lib.embeddedimage import PyEmbeddedImage
from datetime import timedelta, datetime

from bosco.util import load_config
from bosco.editor import RunFinder, RunEditor, TeamEditor, RunEditorException, Reports
from bosco.sireader import SIReaderException, SIReaderTimeout, SIReaderCardChanged

conf = load_config()

# begin wxGlade: extracode
# end wxGlade

sicard = PyEmbeddedImage(
    "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"
    "QmCC")


class ReportsPanel(wx.Panel):
    def __init__(self, *args, **kwds):
        # begin wxGlade: ReportsPanel.__init__
        kwds["style"] = wx.TAB_TRAVERSAL
        wx.Panel.__init__(self, *args, **kwds)
        self.label_10 = wx.StaticText(self, wx.ID_ANY, "Select Report:")
        self.report_combo = wx.ComboBox(self, wx.ID_ANY, choices=[], style=wx.CB_DROPDOWN | wx.CB_READONLY)
        self.run_grid = wx.grid.Grid(self, wx.ID_ANY, size=(1, 1))

        self.__set_properties()
        self.__do_layout()

        self.Bind(wx.EVT_COMBOBOX, self.ChangeReport, self.report_combo)
        # end wxGlade

        self._reports = Reports(conf.store, conf.event)

        # populate reports list
        for r in self._reports.list_reports():
            self.report_combo.Append(r[1], r[0])

    def __set_properties(self):
        # begin wxGlade: ReportsPanel.__set_properties
        self.run_grid.CreateGrid(0, 10)
        self.run_grid.EnableEditing(0)
        self.run_grid.EnableDragRowSize(0)
        self.run_grid.EnableDragGridSize(0)
        self.run_grid.SetSelectionMode(wx.grid.Grid.wxGridSelectRows)
        self.run_grid.SetColLabelValue(0, "Run ID")
        self.run_grid.SetColLabelValue(1, "Course")
        self.run_grid.SetColLabelValue(2, "Runner")
        self.run_grid.SetColLabelValue(3, "SI-Card")
        self.run_grid.SetColLabelValue(4, "Team")
        self.run_grid.SetColLabelValue(5, "Start")
        self.run_grid.SetColLabelValue(6, "Finish")
        self.run_grid.SetColLabelValue(7, "Validation")
        self.run_grid.SetColLabelValue(8, "Team Validation")
        self.run_grid.SetColLabelValue(9, "Score")
        # end wxGlade

    def __do_layout(self):
        # begin wxGlade: ReportsPanel.__do_layout
        sizer_33 = wx.BoxSizer(wx.VERTICAL)
        sizer_34 = wx.BoxSizer(wx.HORIZONTAL)
        sizer_34.Add(self.label_10, 0, wx.ALIGN_CENTER_VERTICAL, 0)
        sizer_34.Add(self.report_combo, 0, 0, 0)
        sizer_33.Add(sizer_34, 0, wx.EXPAND, 0)
        sizer_33.Add((20, 10), 0, 0, 0)
        sizer_33.Add(self.run_grid, 1, wx.EXPAND, 0)
        self.SetSizer(sizer_33)
        sizer_33.Fit(self)
        # end wxGlade

    def update(self):
        busy = wx.BusyCursor()

        try:
            runs = self._reports.runs
            grid_size = self.run_grid.GetNumberRows()
            if len(runs) > grid_size:
                self.run_grid.AppendRows(numRows = len(runs) - grid_size)
            elif len(runs) < grid_size:
                self.run_grid.DeleteRows(numRows = grid_size - len(runs))

            for row, r in enumerate(runs):
                for col, v in enumerate(r):
                    self.run_grid.SetCellValue(row, col, v)

            self.run_grid.AutoSize()
            self.Layout()
        finally:
            del busy

    def ChangeReport(self, event):  # wxGlade: ReportsPanel.<event_handler>
        report = self.report_combo.GetClientData(self.report_combo.GetSelection())
        self._reports.set_report(report)

        # update run list
        self.update()

# end of class ReportsPanel
class RunEditorFrame(wx.Frame):
    def __init__(self, *args, **kwds):
        # begin wxGlade: RunEditorFrame.__init__
        kwds["style"] = wx.DEFAULT_FRAME_STYLE
        wx.Frame.__init__(self, *args, **kwds)
        
        # Menu Bar
        self.main_frame_menubar = wx.MenuBar()
        self.file = wx.Menu()
        self.file.Append(wx.ID_EXIT, "", "", wx.ITEM_NORMAL)
        self.main_frame_menubar.Append(self.file, "&File")
        self.reports = wx.Menu()
        self.open_runs = wx.MenuItem(self.reports, wx.ID_ANY, "&Open runs", "List not yet completed runs", wx.ITEM_NORMAL)
        self.reports.AppendItem(self.open_runs)
        self.orphan_runs = wx.MenuItem(self.reports, wx.ID_ANY, "&Orphan runs", "List runs not connected to a runner", wx.ITEM_NORMAL)
        self.reports.AppendItem(self.orphan_runs)
        self.main_frame_menubar.Append(self.reports, "&Reports")
        self.settings = wx.Menu()
        self.connect_reader = wx.MenuItem(self.settings, wx.ID_ANY, "&Connect SI-Reader", "", wx.ITEM_NORMAL)
        self.settings.AppendItem(self.connect_reader)
        self.print_command = wx.MenuItem(self.settings, wx.ID_ANY, "&Print command", "", wx.ITEM_NORMAL)
        self.settings.AppendItem(self.print_command)
        self.main_frame_menubar.Append(self.settings, "&Settings")
        self.SetMenuBar(self.main_frame_menubar)
        # Menu Bar end
        self.statusbar = self.CreateStatusBar(2, 0)
        self.notebook = wx.Notebook(self, wx.ID_ANY, style=0)
        self.edit_run_page = EditRunPanel(self.notebook, wx.ID_ANY)
        self.readout_run_page = ReadoutRunPanel(self.notebook, wx.ID_ANY)
        self.team_page = TeamPanel(self.notebook, wx.ID_ANY)
        self.reports_page = ReportsPanel(self.notebook, wx.ID_ANY)

        self.__set_properties()
        self.__do_layout()

        self.Bind(wx.EVT_MENU, self.Quit, id=wx.ID_EXIT)
        self.Bind(wx.EVT_MENU, self.OpenRuns, self.open_runs)
        self.Bind(wx.EVT_MENU, self.OrphanRuns, self.orphan_runs)
        self.Bind(wx.EVT_MENU, self.ConnectReader, self.connect_reader)
        self.Bind(wx.EVT_MENU, self.SetPrintCommand, self.print_command)
        # end wxGlade
        
        # Setting editor and selector, it would be cleaner to do this via a custom constructor, 
        # but wxglade doesn't allow this.
        self.editor = RunEditor(conf.store, conf.event)
        self.editor.add_observer(self)
        self.update(self.editor, 'reader')

        # Add timer to periodically poll the si reader
        self.Bind(wx.EVT_TIMER, self.OnTimer)
        self._timer = wx.Timer(self)
        self._timer.Start(milliseconds=500, oneShot=False)
        self.Bind(wx.EVT_CLOSE, self.OnWindowClose)
        
    def __set_properties(self):
        # begin wxGlade: RunEditorFrame.__set_properties
        self.SetTitle("Run Editor")
        self.SetSize((885, 836))
        self.statusbar.SetStatusWidths([-1, 250])
        # statusbar fields
        statusbar_fields = ["Waiting for SI-Card...", "/dev/ttyUSB0 (at 38400 baud)"]
        for i in range(len(statusbar_fields)):
            self.statusbar.SetStatusText(statusbar_fields[i], i)
        # end wxGlade

        self.SetIcon(sicard.GetIcon())

    def __do_layout(self):
        # begin wxGlade: RunEditorFrame.__do_layout
        sizer_1 = wx.BoxSizer(wx.VERTICAL)
        self.notebook.AddPage(self.edit_run_page, "Edit Run")
        self.notebook.AddPage(self.readout_run_page, "Read SI-Card")
        self.notebook.AddPage(self.team_page, "Team Overview")
        self.notebook.AddPage(self.reports_page, "Reports")
        sizer_1.Add(self.notebook, 1, wx.EXPAND, 0)
        self.SetSizer(sizer_1)
        self.Layout()
        # end wxGlade

    def OnWindowClose(self, event):
        self._timer.Stop()
        del self._timer
        self.Destroy()
        
    def OnTimer(self, event):
        try:
            self.editor.poll_reader()
        except SIReaderException, msg:
            self.ErrorDialog(str(msg), 'Error communicating to the SI-Reader')
        
    def update(self, observable, event):
        
        if type(observable) == RunEditor and event == 'reader':
            self.statusbar.SetStatusText(observable.status, 0)
            self.statusbar.SetStatusText(observable.port, 1)
            wx.Yield()

    def Quit(self, event): # wxGlade: RunEditorFrame.<event_handler>
        self.Close(True)

    def ConnectReader(self, event): # wxGlade: RunEditorFrame.<event_handler>
        try:
            self.editor.connect_reader()
        except RunEditorException, e:
            self.ErrorDialog(e.message, "Error Connecting SI-Reader")

    def ErrorDialog(self, msg, title):
        dlg =  wx.MessageDialog(self, msg, title,
                                wx.OK | wx.ICON_ERROR)
        dlg.ShowModal()
        dlg.Destroy()

    def SetPrintCommand(self, event): # wxGlade: RunEditorFrame.<event_handler>
        dlg = wx.TextEntryDialog(self, "Command used to print:", "Print command")
        dlg.SetValue(self.editor.print_command)
        answer = dlg.ShowModal()
        if answer == wx.ID_OK:
            self.editor.set_print_command(dlg.GetValue())
        dlg.Destroy()

    def OpenRuns(self, event):  # wxGlade: RunEditorFrame.<event_handler>
        print "Event handler 'OpenRuns' not implemented!"
        event.Skip()

    def OrphanRuns(self, event):  # wxGlade: RunEditorFrame.<event_handler>
        print "Event handler 'OrphanRuns' not implemented!"
        event.Skip()
# end of class RunEditorFrame

class RunSearchWidget(wx.SearchCtrl):

    def __init__(self, *args, **kwargs):
        super(RunSearchWidget, self).__init__(*args, **kwargs)
        self._finder = None
        self.Disable()

        self.Bind(wx.EVT_SEARCHCTRL_SEARCH_BTN, self.SetSearchTerm, self)
        self.Bind(wx.EVT_TEXT, self.SetSearchTerm, self)

    def SetFinder(self, finder):
        self._finder = finder
        if finder is not None:

            # construct the search domain menu
            self._menu = wx.Menu()
            self._search_domains = self._finder.get_search_domains()
            for m in self._search_domains:
                item = self._menu.AppendRadioItem(-1, m[1])
                self.Bind(wx.EVT_MENU, self.SetSearchDomain, item)
                # set search domain to runner
                if m[0] == 'runner':
                    item.Toggle()
            self.SetMenu(self._menu)
            self.Enable()
        else:
            self.Disable()

    def SetSearchDomain(self, event):
         for i,item in enumerate(self.GetMenu().GetMenuItems()):
            if item.IsChecked():
                self._finder.set_search_domain(self._search_domains[i][0])
                self.SetDescriptiveText("Search in %s" % self._search_domains[i][1])

    def SetSearchTerm(self, event):
        self._finder.set_search_term(self.GetValue())

class EditingPanel(ScrolledPanel):
    def __init__(self, *args, **kwds):
        ScrolledPanel.__init__(self, *args, **kwds)
        self.SetupScrolling()

    @staticmethod    
    def SetValidationLabel(label, result):
        label.SetLabel(result)
        if result == 'OK':
            label.SetForegroundColour('Green')
        elif result == 'NA':
            label.SetForegroundColour('Gray')
        else:
            label.SetForegroundColour('Red')
       
class TeamPanel(EditingPanel):
    def __init__(self, *args, **kwds):
        # begin wxGlade: TeamPanel.__init__
        kwds["style"] = wx.TAB_TRAVERSAL
        EditingPanel.__init__(self, *args, **kwds)
        self.label_11 = wx.StaticText(self, wx.ID_ANY, "Select Team:")
        self.team_combo = wx.ComboBox(self, wx.ID_ANY, choices=[], style=wx.CB_DROPDOWN)
        self.validation = wx.StaticText(self, wx.ID_ANY, "not yet finished")
        self.label_9 = wx.StaticText(self, wx.ID_ANY, "Team Score:")
        self.score = wx.StaticText(self, wx.ID_ANY, "Runs: 41, Time:23:34:76")
        self.run_grid = wx.grid.Grid(self, wx.ID_ANY, size=(1, 1))

        self.__set_properties()
        self.__do_layout()

        self.Bind(wx.EVT_COMBOBOX, self.ChangeTeam, self.team_combo)
        # end wxGlade
        
        self.editor = TeamEditor(conf.store, conf.event)
        self.editor.add_observer(self)
        
        # set teamlist into selector
        for t in self.editor.get_teamlist():
            self.team_combo.Append(t[1], t[0])

        self.update(self.editor, None)

    def __set_properties(self):
        # begin wxGlade: TeamPanel.__set_properties
        self.team_combo.SetMinSize((300, 27))
        self.validation.SetForegroundColour(wx.Colour(255, 0, 0))
        self.validation.SetFont(wx.Font(12, wx.DEFAULT, wx.NORMAL, wx.BOLD, 0, ""))
        self.score.SetFont(wx.Font(12, wx.DEFAULT, wx.NORMAL, wx.BOLD, 0, ""))
        self.run_grid.CreateGrid(0, 10)
        self.run_grid.EnableEditing(0)
        self.run_grid.EnableDragColSize(0)
        self.run_grid.EnableDragRowSize(0)
        self.run_grid.EnableDragGridSize(0)
        self.run_grid.SetColLabelValue(0, "Run ID")
        self.run_grid.SetColLabelValue(1, "Course")
        self.run_grid.SetColLabelValue(2, "Runner")
        self.run_grid.SetColLabelValue(3, "SI-Card")
        self.run_grid.SetColLabelValue(4, "Team")
        self.run_grid.SetColLabelValue(5, "Start")
        self.run_grid.SetColLabelValue(6, "Finish")
        self.run_grid.SetColLabelValue(7, "Validation")
        self.run_grid.SetColLabelValue(8, "Team Validation")
        self.run_grid.SetColLabelValue(9, "Score")
        # end wxGlade

    def __do_layout(self):
        # begin wxGlade: TeamPanel.__do_layout
        sizer_20 = wx.BoxSizer(wx.VERTICAL)
        sizer_21 = wx.BoxSizer(wx.HORIZONTAL)
        sizer_22 = wx.BoxSizer(wx.HORIZONTAL)
        sizer_22.Add(self.label_11, 0, wx.ALL | wx.ALIGN_CENTER_VERTICAL, 5)
        sizer_22.Add(self.team_combo, 0, wx.ALL, 5)
        sizer_20.Add(sizer_22, 0, wx.EXPAND, 0)
        label_6_copy_2 = wx.StaticText(self, wx.ID_ANY, "Team Validation:")
        sizer_21.Add(label_6_copy_2, 0, wx.ALL | wx.ALIGN_CENTER_VERTICAL, 5)
        sizer_21.Add(self.validation, 0, wx.ALL | wx.ALIGN_CENTER_VERTICAL, 5)
        sizer_21.Add(self.label_9, 0, wx.ALL | wx.ALIGN_CENTER_VERTICAL, 5)
        sizer_21.Add(self.score, 0, wx.ALL | wx.ALIGN_CENTER_VERTICAL, 5)
        sizer_20.Add(sizer_21, 0, wx.EXPAND, 0)
        sizer_20.Add(self.run_grid, 1, wx.EXPAND, 0)
        self.SetSizer(sizer_20)
        sizer_20.Fit(self)
        # end wxGlade

    def update(self, observable, event):
        busy = wx.BusyCursor()

        try:
            self.SetValidationLabel(self.validation, self.editor.validation)
                            
            self.score.SetLabel(self.editor.score)

            runs = self.editor.runs
            grid_size = self.run_grid.GetNumberRows()
            if len(runs) > grid_size:
                self.run_grid.AppendRows(numRows = len(runs) - grid_size)
            elif len(runs) < grid_size:
                self.run_grid.DeleteRows(numRows = grid_size - len(runs))
            
            for row, r in enumerate(runs):
                for col, v in enumerate(r):
                    self.run_grid.SetCellValue(row, col, v)
                
            self.run_grid.AutoSize()
            self.Layout()
        finally:
            del busy

    def ChangeTeam(self, event): # wxGlade: TeamPanel.<event_handler>
        team = self.team_combo.GetClientData(self.team_combo.GetSelection())
        self.editor.load(team)
        

# end of class TeamPanel

class RunPanel(EditingPanel):
    def __init__(self, *args, **kwds):
        EditingPanel.__init__(self, *args, **kwds)
        
        self.editor = RunEditor(conf.store, conf.event)
        self.editor.add_observer(self)

    def UpdateRun(self):
        self.runner_sicard.SetLabel(self.editor.runner_sicard)

        self.run_id.SetLabel(self.editor.run_id)
        self.SetValidationLabel(self.run_validation, self.editor.run_validation)
        self.SetValidationLabel(self.team_validation, self.editor.team_validation)
        self.run_score.SetLabel(self.editor.run_score)
        self.team_score.SetLabel(self.editor.team_score)

        self.clear_time.SetLabel(self.editor.run_clear_time)
        self.check_time.SetLabel(self.editor.run_check_time)

        punchlist = self.editor.punchlist
        grid_size = self.punches_grid.GetNumberRows()
        if len(punchlist) > grid_size:
            self.punches_grid.AppendRows(numRows = len(punchlist) - grid_size)
        elif len(punchlist) < grid_size:
            self.punches_grid.DeleteRows(numRows = grid_size - len(punchlist))
            
        for row, p in enumerate(punchlist):
            self.punches_grid.SetReadOnly(row,0)
            self.punches_grid.SetReadOnly(row,1)
            self.punches_grid.SetReadOnly(row,2)
            self.punches_grid.SetReadOnly(row,3)
            self.punches_grid.SetCellRenderer(row,3,
                                              wx.grid.GridCellDateTimeRenderer())
            self.punches_grid.SetCellRenderer(row,4,
                                              wx.grid.GridCellDateTimeRenderer())
            self.punches_grid.SetCellRenderer(row,5, wx.grid.GridCellBoolRenderer())
            self.punches_grid.SetCellEditor(row,5, wx.grid.GridCellBoolEditor())
            self.punches_grid.SetReadOnly(row,6)
            for col, v in enumerate(p):
                self.punches_grid.SetCellValue(row, col, v)
                    
                if p[6] == 'missing':
                    self.punches_grid.SetCellTextColour(row,col,'Red')
                elif p[6] == 'additional' or p[6] == 'ignored':
                    self.punches_grid.SetCellTextColour(row,col,'Gray')
                elif p[6] == 'ok':
                    self.punches_grid.SetCellTextColour(row,col,'Green')
                else:
                    self.punches_grid.SetCellTextColour(row,col,'Black')

                if p[6] == 'missing' and col == 5:
                    self.punches_grid.SetReadOnly(row,col)
                elif col == 5:
                    self.punches_grid.SetReadOnly(row,col, False)

        self.punches_grid.AutoSize()
        self.Layout()

class EditRunPanel(RunPanel):
    def __init__(self, *args, **kwds):
        # begin wxGlade: EditRunPanel.__init__
        kwds["style"] = wx.TAB_TRAVERSAL
        RunPanel.__init__(self, *args, **kwds)
        self.window_1 = wx.SplitterWindow(self, wx.ID_ANY, style=wx.SP_3D | wx.SP_BORDER)
        self.window_1_pane_1 = wx.Panel(self.window_1, wx.ID_ANY)
        self.searchbox = RunSearchWidget(self.window_1_pane_1, wx.ID_ANY)
        self.searchresults = wx.ListCtrl(self.window_1_pane_1, wx.ID_ANY, style=wx.LC_REPORT | wx.LC_SINGLE_SEL | wx.SUNKEN_BORDER)
        self.sizer_30_staticbox = wx.StaticBox(self.window_1_pane_1, wx.ID_ANY, "Select Run")
        self.rollback = wx.Button(self.window_1_pane_1, wx.ID_REFRESH, "")
        self.delete = wx.Button(self.window_1_pane_1, wx.ID_DELETE, "")
        self.add_button = wx.Button(self.window_1_pane_1, wx.ID_ADD, "")
        self.registration = wx.CheckBox(self.window_1_pane_1, wx.ID_ANY, "Registration mode")
        self.print_button = wx.Button(self.window_1_pane_1, wx.ID_PRINT, "")
        self.window_1_pane_2 = wx.Panel(self.window_1, wx.ID_ANY)
        self.run_runner_combo = wx.ComboBox(self.window_1_pane_2, wx.ID_ANY, choices=[], style=wx.CB_DROPDOWN | wx.CB_DROPDOWN | wx.CB_READONLY)
        self.runner_number = wx.TextCtrl(self.window_1_pane_2, wx.ID_ANY, "101A")
        self.label_1 = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Category:")
        self.runner_category = wx.TextCtrl(self.window_1_pane_2, wx.ID_ANY, "")
        self.runner_given_name = wx.TextCtrl(self.window_1_pane_2, wx.ID_ANY, "Gaudenz")
        self.runner_surname = wx.TextCtrl(self.window_1_pane_2, wx.ID_ANY, "Steinlin")
        self.label_4 = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Date of birth:")
        self.runner_dateofbirth = wx.TextCtrl(self.window_1_pane_2, wx.ID_ANY, "1975-10-05")
        self.runner_team = wx.ComboBox(self.window_1_pane_2, wx.ID_ANY, choices=[], style=wx.CB_DROPDOWN | wx.CB_DROPDOWN | wx.CB_READONLY)
        self.sizer_8_staticbox = wx.StaticBox(self.window_1_pane_2, wx.ID_ANY, "Runner")
        self.run_id = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "1234")
        self.course = wx.TextCtrl(self.window_1_pane_2, wx.ID_ANY, "LDN1", style=wx.TE_PROCESS_ENTER)
        self.label_12 = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Manual start time:")
        self.manual_start_time = wx.TextCtrl(self.window_1_pane_2, wx.ID_ANY, "")
        self.label_13 = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Manual finish time:")
        self.manual_finish_time = wx.TextCtrl(self.window_1_pane_2, wx.ID_ANY, "")
        self.override = wx.RadioBox(self.window_1_pane_2, wx.ID_ANY, "Override Validation", choices=["no override", "OK", "not completed", "missing controls", "did not finish", "did not start"], majorDimension=6, style=wx.RA_SPECIFY_ROWS)
        self.complete = wx.CheckBox(self.window_1_pane_2, wx.ID_ANY, "Run complete")
        self.sizer_2_copy_staticbox = wx.StaticBox(self.window_1_pane_2, wx.ID_ANY, "Run")
        self.run_validation = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "OK")
        self.team_validation = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "not yet finished")
        self.run_score = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "1:05:23")
        self.team_score = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Runs: 21, Time: 9:04:32")
        self.sizer_25_staticbox = wx.StaticBox(self.window_1_pane_2, wx.ID_ANY, "Validation and Scoreing")
        self.label_5 = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Clear time:")
        self.label_7 = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Check time:")
        self.label_7_copy = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Start time:")
        self.label_7_copy_1 = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Finish time:")
        self.runner_sicard = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "7644523")
        self.readout_time = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "2008-05-04 12:00:54")
        self.clear_time = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "2008-05-04 11:02:54")
        self.check_time = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "2008-05-04 11:03:01")
        self.card_start_time = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "2008-05-04 11:05:29")
        self.card_finish_time = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "2008-05-04 11:58:01")
        self.sizer_26_staticbox = wx.StaticBox(self.window_1_pane_2, wx.ID_ANY, "SI-Card Times")
        self.punches_grid = wx.grid.Grid(self.window_1_pane_2, wx.ID_ANY, size=(1, 1))
        self.sizer_16_staticbox = wx.StaticBox(self.window_1_pane_2, wx.ID_ANY, "Punches")

        self.__set_properties()
        self.__do_layout()

        self.Bind(wx.EVT_LIST_ITEM_SELECTED, self.SetRun, self.searchresults)
        self.Bind(wx.EVT_LIST_ITEM_ACTIVATED, self.SetRun, self.searchresults)
        self.Bind(wx.EVT_BUTTON, self.Rollback, self.rollback)
        self.Bind(wx.EVT_BUTTON, self.DeleteRun, self.delete)
        self.Bind(wx.EVT_BUTTON, self.AddRun, self.add_button)
        self.Bind(wx.EVT_BUTTON, self.OnPrint, self.print_button)
        self.Bind(wx.EVT_COMBOBOX, self.SetRunRunner, self.run_runner_combo)
        self.Bind(wx.EVT_TEXT, self.FieldChanged, self.runner_number)
        self.Bind(wx.EVT_TEXT, self.FieldChanged, self.runner_category)
        self.Bind(wx.EVT_TEXT, self.FieldChanged, self.runner_given_name)
        self.Bind(wx.EVT_TEXT, self.FieldChanged, self.runner_surname)
        self.Bind(wx.EVT_TEXT, self.FieldChanged, self.runner_dateofbirth)
        self.Bind(wx.EVT_COMBOBOX, self.SetRunnerTeam, self.runner_team)
        self.Bind(wx.EVT_TEXT, self.SetCourse, self.course)
        self.Bind(wx.EVT_TEXT, self.FieldChanged, self.manual_start_time)
        self.Bind(wx.EVT_TEXT, self.FieldChanged, self.manual_finish_time)
        self.Bind(wx.EVT_RADIOBOX, self.SetOverride, self.override)
        self.Bind(wx.EVT_CHECKBOX, self.SetComplete, self.complete)
        self.Bind(wx.grid.EVT_GRID_CMD_CELL_CHANGE, self.ChangePunch, self.punches_grid)
        self.Bind(wx.grid.EVT_GRID_CMD_EDITOR_HIDDEN, self.ExitPunch, self.punches_grid)
        self.Bind(wx.grid.EVT_GRID_CMD_EDITOR_SHOWN, self.EditPunch, self.punches_grid)
        # end wxGlade

        # set searchresult column headers
        self.searchresults.InsertColumn(0, "ID")
        self.searchresults.SetColumnWidth(0, 30)
        self.searchresults.InsertColumn(1, "Course")
        self.searchresults.SetColumnWidth(1, 60)
        self.searchresults.InsertColumn(2, "Readout time")
        self.searchresults.SetColumnWidth(2, 100)
        self.searchresults.InsertColumn(3, "Number")
        self.searchresults.SetColumnWidth(3, 60)
        self.searchresults.InsertColumn(4, "Runner")
        self.searchresults.SetColumnWidth(4, 220)
        self.searchresults.InsertColumn(5, "Team")
        self.searchresults.SetColumnWidth(5, 220)
        self.searchresults.InsertColumn(6, "Category")
        self.searchresults.SetColumnWidth(6, 60)

        self.manual_start_time.Bind(wx.EVT_KILL_FOCUS, self.SetManualStartTime)
        self.manual_finish_time.Bind(wx.EVT_KILL_FOCUS, self.SetManualFinishTime)
        self.runner_number.Bind(wx.EVT_KILL_FOCUS, self.SetRunnerNumber)
        self.runner_category.Bind(wx.EVT_KILL_FOCUS, self.SetRunnerCategory)
        self.runner_given_name.Bind(wx.EVT_KILL_FOCUS, self.SetRunnerGivenName)
        self.runner_surname.Bind(wx.EVT_KILL_FOCUS, self.SetRunnerSurname)
        self.runner_dateofbirth.Bind(wx.EVT_KILL_FOCUS, self.SetRunnerDateofbirth)

        # To avoid updates if the field is not changed and the focus just enters the
        # field and leaves it again without the user changeing any text, track if the field
        # was changed: self.ResetFieldChanged sets self.field_changed = False and self.FieldChanged
        # which is called on any EVT_TEXT event sets it to True. All the callbacks called on EVT_KILL_FOCUS
        # first check this self.field_changed.
        for field in (self.manual_start_time, self.manual_finish_time, self.runner_number,
                      self.runner_category, self.runner_given_name, self.runner_surname, 
                      self.runner_dateofbirth):
            field.Bind(wx.EVT_SET_FOCUS, self.ResetFieldChanged)
        
        self.finder = RunFinder(conf.store)
        self.finder.add_observer(self)
        self.searchbox.SetFinder(self.finder)
        self.update(self.finder, None)
        self.update(self.editor, 'run')
        
        self.UpdateCombo(self.run_runner_combo, None, self.editor.get_runnerlist())
        self.UpdateCombo(self.runner_team, None, self.editor.get_teamlist())

    def __set_properties(self):
        # begin wxGlade: EditRunPanel.__set_properties
        self.run_runner_combo.SetMinSize((250, 27))
        self.runner_number.SetMinSize((122, 25))
        self.runner_category.SetMinSize((122, 25))
        self.runner_given_name.SetMinSize((122, 25))
        self.runner_surname.SetMinSize((122, 25))
        self.runner_dateofbirth.SetMinSize((90, 25))
        self.runner_team.SetMinSize((250, 27))
        self.course.SetMinSize((150, 25))
        self.manual_start_time.SetMinSize((150, 25))
        self.manual_finish_time.SetMinSize((150, 25))
        self.override.SetSelection(0)
        self.complete.SetValue(1)
        self.run_validation.SetForegroundColour(wx.Colour(0, 255, 0))
        self.team_validation.SetForegroundColour(wx.Colour(255, 0, 0))
        self.punches_grid.CreateGrid(0, 7)
        self.punches_grid.SetRowLabelSize(30)
        self.punches_grid.EnableDragColSize(0)
        self.punches_grid.EnableDragRowSize(0)
        self.punches_grid.EnableDragGridSize(0)
        self.punches_grid.SetColLabelValue(0, "Nr.")
        self.punches_grid.SetColLabelValue(1, "Control")
        self.punches_grid.SetColLabelValue(2, "SI")
        self.punches_grid.SetColLabelValue(3, "Card Punchtime")
        self.punches_grid.SetColLabelValue(4, "Manual Punchtime")
        self.punches_grid.SetColLabelValue(5, "Ignore")
        self.punches_grid.SetColLabelValue(6, "")
        # end wxGlade

    def __do_layout(self):
        # begin wxGlade: EditRunPanel.__do_layout
        sizer_5 = wx.BoxSizer(wx.VERTICAL)
        sizer_2 = wx.BoxSizer(wx.VERTICAL)
        self.sizer_16_staticbox.Lower()
        sizer_16 = wx.StaticBoxSizer(self.sizer_16_staticbox, wx.VERTICAL)
        sizer_9 = wx.BoxSizer(wx.HORIZONTAL)
        sizer_24 = wx.BoxSizer(wx.VERTICAL)
        self.sizer_26_staticbox.Lower()
        sizer_26 = wx.StaticBoxSizer(self.sizer_26_staticbox, wx.HORIZONTAL)
        sizer_23_copy = wx.BoxSizer(wx.VERTICAL)
        sizer_6 = wx.BoxSizer(wx.VERTICAL)
        self.sizer_25_staticbox.Lower()
        sizer_25 = wx.StaticBoxSizer(self.sizer_25_staticbox, wx.HORIZONTAL)
        sizer_23 = wx.BoxSizer(wx.VERTICAL)
        sizer_6_copy = wx.BoxSizer(wx.VERTICAL)
        self.sizer_2_copy_staticbox.Lower()
        sizer_2_copy = wx.StaticBoxSizer(self.sizer_2_copy_staticbox, wx.HORIZONTAL)
        sizer_10 = wx.BoxSizer(wx.VERTICAL)
        sizer_4 = wx.BoxSizer(wx.VERTICAL)
        sizer_27 = wx.BoxSizer(wx.HORIZONTAL)
        self.sizer_8_staticbox.Lower()
        sizer_8 = wx.StaticBoxSizer(self.sizer_8_staticbox, wx.VERTICAL)
        sizer_29 = wx.BoxSizer(wx.HORIZONTAL)
        sizer_28 = wx.BoxSizer(wx.HORIZONTAL)
        sizer_7 = wx.BoxSizer(wx.HORIZONTAL)
        sizer_32 = wx.BoxSizer(wx.VERTICAL)
        sizer_31 = wx.BoxSizer(wx.VERTICAL)
        sizer_13 = wx.BoxSizer(wx.HORIZONTAL)
        sizer_19 = wx.BoxSizer(wx.VERTICAL)
        self.sizer_30_staticbox.Lower()
        sizer_30 = wx.StaticBoxSizer(self.sizer_30_staticbox, wx.VERTICAL)
        sizer_30.Add(self.searchbox, 0, wx.ALL | wx.EXPAND, 3)
        sizer_30.Add(self.searchresults, 1, wx.ALL | wx.EXPAND, 3)
        sizer_13.Add(sizer_30, 1, wx.EXPAND, 0)
        sizer_19.Add(self.rollback, 0, wx.ALL | wx.EXPAND | wx.ALIGN_CENTER_VERTICAL, 2)
        sizer_19.Add(self.delete, 0, wx.ALL | wx.EXPAND | wx.ALIGN_CENTER_VERTICAL, 2)
        sizer_19.Add(self.add_button, 0, wx.ALL | wx.EXPAND | wx.ALIGN_CENTER_VERTICAL, 2)
        sizer_19.Add(self.registration, 0, wx.ALL, 2)
        sizer_19.Add(self.print_button, 0, wx.ALL | wx.EXPAND | wx.ALIGN_CENTER_VERTICAL, 2)
        sizer_13.Add(sizer_19, 0, wx.EXPAND, 0)
        self.window_1_pane_1.SetSizer(sizer_13)
        label_2 = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Change Runner:")
        sizer_8.Add(label_2, 0, wx.ALL | wx.ALIGN_CENTER_VERTICAL, 0)
        sizer_8.Add(self.run_runner_combo, 0, wx.ALL | wx.ALIGN_CENTER_VERTICAL, 0)
        sizer_8.Add((20, 5), 0, 0, 0)
        label_20_copy = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Number:")
        sizer_31.Add(label_20_copy, 0, wx.ALL, 0)
        sizer_31.Add(self.runner_number, 0, wx.ALL, 0)
        sizer_7.Add(sizer_31, 1, wx.EXPAND, 0)
        sizer_32.Add(self.label_1, 0, wx.ALL, 0)
        sizer_32.Add(self.runner_category, 0, wx.ALL, 0)
        sizer_7.Add(sizer_32, 1, wx.EXPAND, 0)
        sizer_8.Add(sizer_7, 0, wx.EXPAND, 0)
        sizer_8.Add((20, 5), 0, 0, 0)
        label_20 = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Runner:")
        sizer_8.Add(label_20, 0, wx.ALL, 0)
        sizer_28.Add(self.runner_given_name, 0, wx.ALL, 0)
        sizer_28.Add(self.runner_surname, 0, wx.ALL, 0)
        sizer_8.Add(sizer_28, 0, wx.EXPAND, 0)
        sizer_29.Add(self.label_4, 0, wx.LEFT | wx.TOP | wx.BOTTOM | wx.ALIGN_CENTER_VERTICAL, 0)
        sizer_29.Add(self.runner_dateofbirth, 0, wx.ALL | wx.ALIGN_RIGHT | wx.ALIGN_CENTER_VERTICAL, 0)
        sizer_8.Add(sizer_29, 0, wx.EXPAND, 0)
        sizer_8.Add((20, 5), 0, 0, 0)
        label_22 = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Team:")
        sizer_8.Add(label_22, 0, wx.ALL, 0)
        sizer_8.Add(self.runner_team, 0, wx.ALL, 0)
        sizer_9.Add(sizer_8, 0, wx.ALL | wx.EXPAND, 5)
        label_24_copy_copy_copy_copy = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Run ID:")
        sizer_27.Add(label_24_copy_copy_copy_copy, 0, wx.ALL, 0)
        sizer_27.Add(self.run_id, 0, wx.ALL, 2)
        sizer_4.Add(sizer_27, 0, wx.EXPAND, 0)
        sizer_4.Add((10, 5), 0, 0, 0)
        label_3 = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Course Code:")
        sizer_4.Add(label_3, 0, wx.ALL | wx.ALIGN_CENTER_VERTICAL, 0)
        sizer_4.Add(self.course, 0, wx.ALL | wx.ALIGN_CENTER_VERTICAL, 0)
        sizer_4.Add((10, 5), 0, 0, 0)
        sizer_4.Add(self.label_12, 0, 0, 0)
        sizer_4.Add(self.manual_start_time, 0, 0, 0)
        sizer_4.Add((10, 5), 0, 0, 0)
        sizer_4.Add(self.label_13, 0, 0, 0)
        sizer_4.Add(self.manual_finish_time, 0, 0, 0)
        sizer_2_copy.Add(sizer_4, 0, wx.EXPAND, 0)
        sizer_2_copy.Add((20, 20), 0, 0, 0)
        sizer_10.Add(self.override, 0, wx.ALL, 2)
        sizer_10.Add(self.complete, 0, wx.ALL, 2)
        sizer_2_copy.Add(sizer_10, 0, wx.EXPAND, 0)
        sizer_9.Add(sizer_2_copy, 0, wx.ALL | wx.EXPAND, 5)
        label_4_copy_1 = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Run Validation:")
        sizer_6_copy.Add(label_4_copy_1, 0, wx.ALL, 0)
        label_6_copy_3 = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Team Validation:")
        sizer_6_copy.Add(label_6_copy_3, 0, wx.ALL, 0)
        label_6_copy_copy_1 = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Score:")
        sizer_6_copy.Add(label_6_copy_copy_1, 0, wx.ALL, 0)
        label_6_copy_copy_copy_copy_copy = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Team Score:")
        sizer_6_copy.Add(label_6_copy_copy_copy_copy_copy, 0, wx.ALL, 0)
        sizer_25.Add(sizer_6_copy, 0, wx.EXPAND, 0)
        sizer_23.Add(self.run_validation, 0, wx.ALL, 0)
        sizer_23.Add(self.team_validation, 0, wx.ALL, 0)
        sizer_23.Add(self.run_score, 0, wx.ALL, 0)
        sizer_23.Add(self.team_score, 0, wx.ALL, 0)
        sizer_25.Add(sizer_23, 0, wx.EXPAND, 0)
        sizer_24.Add(sizer_25, 0, wx.ALL | wx.EXPAND, 5)
        label_24 = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "SI-Card:")
        sizer_6.Add(label_24, 0, wx.ALL, 0)
        label_26 = wx.StaticText(self.window_1_pane_2, wx.ID_ANY, "Readout time:")
        sizer_6.Add(label_26, 0, wx.ALL, 0)
        sizer_6.Add(self.label_5, 0, wx.ALL, 0)
        sizer_6.Add(self.label_7, 0, wx.ALL, 0)
        sizer_6.Add(self.label_7_copy, 0, wx.ALL, 0)
        sizer_6.Add(self.label_7_copy_1, 0, wx.ALL, 0)
        sizer_26.Add(sizer_6, 0, wx.EXPAND, 0)
        sizer_23_copy.Add(self.runner_sicard, 0, wx.ALL, 0)
        sizer_23_copy.Add(self.readout_time, 0, wx.ALL, 0)
        sizer_23_copy.Add(self.clear_time, 0, wx.ALL, 0)
        sizer_23_copy.Add(self.check_time, 0, wx.ALL, 0)
        sizer_23_copy.Add(self.card_start_time, 0, wx.ALL, 0)
        sizer_23_copy.Add(self.card_finish_time, 0, wx.ALL, 0)
        sizer_26.Add(sizer_23_copy, 0, wx.EXPAND, 0)
        sizer_24.Add(sizer_26, 1, wx.ALL | wx.EXPAND, 5)
        sizer_9.Add(sizer_24, 0, wx.EXPAND, 0)
        sizer_2.Add(sizer_9, 0, wx.EXPAND, 0)
        sizer_16.Add(self.punches_grid, 1, wx.ALL | wx.EXPAND, 5)
        sizer_2.Add(sizer_16, 1, wx.ALL | wx.EXPAND, 5)
        self.window_1_pane_2.SetSizer(sizer_2)
        self.window_1.SplitHorizontally(self.window_1_pane_1, self.window_1_pane_2)
        sizer_5.Add(self.window_1, 1, wx.EXPAND, 0)
        self.SetSizer(sizer_5)
        sizer_5.Fit(self)
        # end wxGlade

    @staticmethod
    def GetComboData(combo):
        return combo.GetClientData(combo.GetSelection())

    def ResetFieldChanged(self, e):
        self.field_changed = False

    def FieldChanged(self, e): # wxGlade: EditRunPanel.<event_handler>
        self.field_changed = True

    def SetRunRunner(self, event): # wxGlade: EditRunPanel.<event_handler>
        self.editor.set_runner(self.GetComboData(self.run_runner_combo))

    def SetCourse(self, event): # wxGlade: EditRunPanel.<event_handler>
        self.editor.set_course(self.course.GetValue().upper().strip())

    def SetManualStartTime(self, event):
        if not self.field_changed:
            return
        
        try: 
            self.editor.set_manual_start_time(self.manual_start_time.GetValue().strip())
        except ValueError, msg:
            self.GetGrandParent().ErrorDialog(str(msg), 'invalid time format')
            self.manual_start_time.SetFocus()

    def SetManualFinishTime(self, event):
        if not self.field_changed:
            return
        
        try:
            self.editor.set_manual_finish_time(self.manual_finish_time.GetValue().strip())
        except ValueError, msg:
            self.GetGrandParent().ErrorDialog(str(msg), 'invalid time format')
            self.manual_finish_time.SetFocus()

    def SetRunnerNumber(self, event):
        if not self.field_changed:
            return
        
        try:
            self.editor.set_runner_number(self.runner_number.GetValue().strip())
        except RunEditorException, e:
            dlg = wx.MessageDialog(self, u'%s Only one runner may have this number. Do you want to assign the number to this runner?' % e.message,
                                   'duplicate number',
                                   style = wx.YES_NO|wx.ICON_QUESTION)
            answer = dlg.ShowModal()
            dlg.Destroy()
            if answer == wx.ID_YES:
                self.editor.set_runner_number(self.runner_number.GetValue().strip(), force = True)
            elif answer == wx.ID_NO:
                self.runner_number.SetValue(self.editor.runner_number)
                self.runner_number.SetFocus()
            
    def SetRunnerCategory(self, event):
        if not self.field_changed:
            return

        self.editor.set_runner_category(self.runner_category.GetValue().upper().strip())
            
    def SetRunnerGivenName(self, event):
        if not self.field_changed:
            return
        
        self.editor.set_runner_given_name(self.runner_given_name.GetValue().strip())

    def SetRunnerSurname(self, event):
        if not self.field_changed:
            return
        
        self.editor.set_runner_surname(self.runner_surname.GetValue().strip())

    def SetRunnerDateofbirth(self, event):
        if not self.field_changed:
            return
        
        try:
            self.editor.set_runner_dateofbirth(self.runner_dateofbirth.GetValue().strip())
        except ValueError, msg:
            self.GetGrandParent().ErrorDialog(str(msg), 'invalid date format')
            self.runner_dateofbirth.SetFocus()
    
    def SetRunnerTeam(self, event): # wxGlade: EditRunPanel.<event_handler>
        self.editor.set_runner_team(self.GetComboData(self.runner_team))

    def SetOverride(self, event): # wxGlade: EditRunPanel.<event_handler>
        self.editor.set_override(self.override.GetSelection())

    def SetComplete(self, event): # wxGlade: EditRunPanel.<event_handler>
        self.editor.set_complete(self.complete.GetValue())

    def Commit(self, event): # wxGlade: EditRunPanel.<event_handler>
        try:
            self.editor.commit()
        except Exception, msg:
            self.editor.rollback()
            self.GetGrandParent().ErrorDialog(str(msg), 'Error saving changes')

    def AddRun(self, event): # wxGlade: EditRunPanel.<event_handler>
        self.editor.new()

    def EditPunch(self, event): # wxGlade: EditRunPanel.<event_handler>

        def FindLastPunchtime(punch):
            if punch == 0:
                return ''

            last_manual = self.punches_grid.GetCellValue(punch-1, 4)
            last_card = self.punches_grid.GetCellValue(punch-1, 3)

            if last_manual != '':
                return last_manual
            elif last_card != '':
                return last_card
            else:
                return FindLastPunchtime(punch-1)
            
        punch = event.GetRow()
        col = event.GetCol()

        # Set default value if no value is set
        if col == 4 and self.punches_grid.GetCellValue(punch, 4) == '':
            if self.punches_grid.GetCellValue(punch, 6) == 'missing':
                punchtime = self.editor.parse_time(FindLastPunchtime(punch))
                if punchtime is not None:
                    # Add 1 second for new punch
                    punchtime += timedelta(seconds=1)
                else:
                    punchtime = str(datetime.now().strftime('%Y-%m-%d %H:%M:%S'))
                wx.CallAfter(self.punches_grid.SetCellValue, punch, col, str(punchtime))
                self._punch_changed = True
            elif col == 4:
                self.punches_grid.SetCellValue(punch, col,
                                               self.punches_grid.GetCellValue(punch, 3))
                self._punch_changed = True

    def ExitPunch(self, event): # wxGlade: EditRunPanel.<event_handler>
        if self._punch_changed:
            self._punch_changed = False
            self.ChangePunch(event)

    def ChangePunch(self, event): # wxGlade: EditRunPanel.<event_handler>
        punch = event.GetRow()
        col = event.GetCol()

        if col == 4:
            try:
                self.editor.set_punchtime(punch,
                                          self.punches_grid.GetCellValue(punch, col).strip())
            except ValueError, msg:
                self.GetGrandParent().ErrorDialog(str(msg), 'invalid time format')
                event.Veto()
                return 
        elif col == 5:
            self.editor.set_ignore(punch,
                                   self.punches_grid.GetCellValue(punch, col))

    def Rollback(self, event): # wxGlade: EditRunPanel.<event_handler>
        self.editor.rollback()

    def SetRun(self, event): # wxGlade: EditRunPanel.<event_handler>
        index = event.m_itemIndex
        self.editor.load(self.searchresults.GetItemData(index))

    def update(self, observable, event):
        
        def update_runfinder():
            if self.finder is not None:
                current_run = self.searchresults.GetItemData(self.searchresults.GetFirstSelected()) or None
                self.searchresults.DeleteAllItems()
                results = self.finder.get_results()
                for row, run in enumerate(results):
                    index = self.searchresults.InsertStringItem(sys.maxint, unicode(run[0]))
                    self.searchresults.SetItemData(index, run[0])
                    for col,v in enumerate(run[0:]):
                        self.searchresults.SetStringItem(index, col, unicode(v))
                    # activate if it's the current run
                    if run[0] == current_run:
                        self.searchresults.SetItemState(index, wx.LIST_STATE_SELECTED, wx.LIST_STATE_SELECTED)

        try:
            busy = wx.BusyCursor()
            
            # Disable Event handling while updating
            self.SetEvtHandlerEnabled(False)
        
            if type(observable) == RunFinder:
                update_runfinder()

            elif type(observable) == RunEditor and event == 'run':
                self.UpdateRun()
                self.course.SetValue(self.editor.run_course)
                self.override.SetSelection(self.editor.run_override)
                self.readout_time.SetLabel(self.editor.run_readout_time)
                self.card_start_time.SetLabel(self.editor.run_card_start_time)
                self.card_finish_time.SetLabel(self.editor.run_card_finish_time)
                self.manual_start_time.SetValue(self.editor.run_manual_start_time)
                self.manual_finish_time.SetValue(self.editor.run_manual_finish_time)
                self.complete.SetValue(self.editor.run_complete)

                self.runner_number.SetValue(self.editor.runner_number)
                self.runner_category.SetValue(self.editor.runner_category)
                self.runner_given_name.SetValue(self.editor.runner_given_name)
                self.runner_surname.SetValue(self.editor.runner_surname)
                self.runner_dateofbirth.SetValue(self.editor.runner_dateofbirth)
                self.runner_team.SetValue(self.editor.runner_team)

                ctrl_list = (self.run_runner_combo, self.runner_number, self.runner_category,
                             self.runner_given_name,
                             self.runner_surname, self.runner_dateofbirth, self.runner_team, self.course,
                             self.manual_start_time, self.manual_finish_time, self.override, self.complete,
                             self.punches_grid)
                if not self.editor.has_run():
                    # Disable all controls if there is no run in the editor
                    for ctrl in ctrl_list:
                        ctrl.Disable()
                else:
                    for ctrl in ctrl_list:
                        ctrl.Enable()

                # also update the runfinder, names may have changed or a run may have been deleted
                # TODO make this more conditional on when the results actually change...
                update_runfinder()

            elif type(observable) == RunEditor and event == 'reader':
                if (self.GetGrandParent().notebook.GetCurrentPage() == self and
                    self.registration.GetValue() and 
                    observable.sicard is not None):
                    observable.new(observable.sicard)

        finally:
            # Enable Event handling after updating
            self.SetEvtHandlerEnabled(True)
            
            # delete the busy cursor even if an exception occurs
            del busy

    @staticmethod
    def UpdateCombo(combo, choice, choice_list):
        combo.Clear()
        choice_index = 0
        for i,c in enumerate(choice_list):
            combo.Append(c[1], c[0])
            if c[0] == choice:
                choice_index = i
        combo.SetSelection(choice_index)

    def OnPrint(self, event):  # wxGlade: EditRunPanel.<event_handler>
        self.editor.print_run()

    def DeleteRun(self, event):  # wxGlade: EditRunPanel.<event_handler>
        self.editor.delete()
# end of class EditRunPanel


class ReadoutRunPanel(RunPanel):
    def __init__(self, *args, **kwds):
        # begin wxGlade: ReadoutRunPanel.__init__
        kwds["style"] = wx.TAB_TRAVERSAL
        RunPanel.__init__(self, *args, **kwds)
        self.progress_bar = wx.Gauge(self, wx.ID_ANY, 10)
        self.progress_text = wx.StaticText(self, wx.ID_ANY, "Reading Card data...")
        self.print_checkbox = wx.CheckBox(self, wx.ID_ANY, "Print run")
        self.runner_number = wx.StaticText(self, wx.ID_ANY, "101A")
        self.label_6 = wx.StaticText(self, wx.ID_ANY, "Category:")
        self.runner_category = wx.StaticText(self, wx.ID_ANY, "HAM")
        self.runner_name = wx.StaticText(self, wx.ID_ANY, "Gaudenz Steinlin")
        self.runner_team = wx.StaticText(self, wx.ID_ANY, u"UBOL 3 \"saugrn\"")
        self.runner_sicard = wx.StaticText(self, wx.ID_ANY, "654324")
        self.sizer_11_staticbox = wx.StaticBox(self, wx.ID_ANY, "Runner Information")
        self.run_validation = wx.StaticText(self, wx.ID_ANY, "OK")
        self.team_validation = wx.StaticText(self, wx.ID_ANY, "not yet finished")
        self.run_score = wx.StaticText(self, wx.ID_ANY, "1:05:23")
        self.team_score = wx.StaticText(self, wx.ID_ANY, "Runs: 21, Time: 9:04:32")
        self.sizer_17_staticbox = wx.StaticBox(self, wx.ID_ANY, "Validation and Scoreing")
        self.label_8 = wx.StaticText(self, wx.ID_ANY, "Course code:")
        self.course = wx.StaticText(self, wx.ID_ANY, "LEN5")
        self.run_id = wx.StaticText(self, wx.ID_ANY, "1234")
        self.label_5_copy = wx.StaticText(self, wx.ID_ANY, "Clear time:")
        self.label_7_copy_2 = wx.StaticText(self, wx.ID_ANY, "Check time:")
        self.clear_time = wx.StaticText(self, wx.ID_ANY, "2008-05-04 11:02:54")
        self.check_time = wx.StaticText(self, wx.ID_ANY, "2008-05-04 11:03:01")
        self.label_7_copy_copy = wx.StaticText(self, wx.ID_ANY, "Start time:")
        self.label_7_copy_1_copy = wx.StaticText(self, wx.ID_ANY, "Finish time:")
        self.start_time = wx.StaticText(self, wx.ID_ANY, "2008-05-04 11:05:29")
        self.finish_time = wx.StaticText(self, wx.ID_ANY, "2008-05-04 11:58:01")
        self.punches_grid = wx.grid.Grid(self, wx.ID_ANY, size=(1, 1))
        self.sizer_14_staticbox = wx.StaticBox(self, wx.ID_ANY, "Run Information")

        self.__set_properties()
        self.__do_layout()
        # end wxGlade
        
        self.update(self.editor,'progress')
        self.update(self.editor, 'run')        

    def __set_properties(self):
        # begin wxGlade: ReadoutRunPanel.__set_properties
        self.runner_number.SetFont(wx.Font(12, wx.DEFAULT, wx.NORMAL, wx.BOLD, 0, ""))
        self.runner_category.SetFont(wx.Font(12, wx.DEFAULT, wx.NORMAL, wx.BOLD, 0, ""))
        self.runner_name.SetFont(wx.Font(12, wx.DEFAULT, wx.NORMAL, wx.BOLD, 0, ""))
        self.runner_team.SetFont(wx.Font(12, wx.DEFAULT, wx.NORMAL, wx.BOLD, 0, ""))
        self.runner_sicard.SetFont(wx.Font(12, wx.DEFAULT, wx.NORMAL, wx.BOLD, 0, ""))
        self.run_validation.SetForegroundColour(wx.Colour(0, 255, 0))
        self.run_validation.SetFont(wx.Font(12, wx.DEFAULT, wx.NORMAL, wx.BOLD, 0, ""))
        self.team_validation.SetForegroundColour(wx.Colour(255, 0, 0))
        self.team_validation.SetFont(wx.Font(12, wx.DEFAULT, wx.NORMAL, wx.BOLD, 0, ""))
        self.run_score.SetFont(wx.Font(12, wx.DEFAULT, wx.NORMAL, wx.BOLD, 0, ""))
        self.team_score.SetFont(wx.Font(12, wx.DEFAULT, wx.NORMAL, wx.BOLD, 0, ""))
        self.course.SetFont(wx.Font(12, wx.DEFAULT, wx.NORMAL, wx.BOLD, 0, ""))
        self.run_id.SetFont(wx.Font(12, wx.DEFAULT, wx.NORMAL, wx.BOLD, 0, ""))
        self.clear_time.SetFont(wx.Font(12, wx.DEFAULT, wx.NORMAL, wx.BOLD, 0, ""))
        self.check_time.SetFont(wx.Font(12, wx.DEFAULT, wx.NORMAL, wx.BOLD, 0, ""))
        self.start_time.SetFont(wx.Font(12, wx.DEFAULT, wx.NORMAL, wx.BOLD, 0, ""))
        self.finish_time.SetFont(wx.Font(12, wx.DEFAULT, wx.NORMAL, wx.BOLD, 0, ""))
        self.punches_grid.CreateGrid(0, 5)
        self.punches_grid.SetRowLabelSize(30)
        self.punches_grid.SetColLabelSize(30)
        self.punches_grid.EnableEditing(0)
        self.punches_grid.EnableDragColSize(0)
        self.punches_grid.EnableDragRowSize(0)
        self.punches_grid.EnableDragGridSize(0)
        self.punches_grid.SetColLabelValue(0, "Nr.")
        self.punches_grid.SetColLabelValue(1, "Control")
        self.punches_grid.SetColLabelValue(2, "SI")
        self.punches_grid.SetColLabelValue(3, "Punchtime")
        self.punches_grid.SetColLabelValue(4, "")
        # end wxGlade

    def __do_layout(self):
        # begin wxGlade: ReadoutRunPanel.__do_layout
        sizer_3 = wx.BoxSizer(wx.VERTICAL)
        sizer_12 = wx.BoxSizer(wx.HORIZONTAL)
        self.sizer_14_staticbox.Lower()
        sizer_14 = wx.StaticBoxSizer(self.sizer_14_staticbox, wx.VERTICAL)
        sizer_18 = wx.GridSizer(6, 2, 0, 0)
        sizer_15 = wx.BoxSizer(wx.VERTICAL)
        self.sizer_17_staticbox.Lower()
        sizer_17 = wx.StaticBoxSizer(self.sizer_17_staticbox, wx.VERTICAL)
        self.sizer_11_staticbox.Lower()
        sizer_11 = wx.StaticBoxSizer(self.sizer_11_staticbox, wx.VERTICAL)
        sizer_3.Add(self.progress_bar, 0, wx.ALL | wx.EXPAND, 5)
        sizer_3.Add(self.progress_text, 0, wx.ALL, 5)
        sizer_3.Add(self.print_checkbox, 0, wx.ALL, 2)
        label_20_copy_copy = wx.StaticText(self, wx.ID_ANY, "Number:")
        sizer_11.Add(label_20_copy_copy, 0, wx.ALL, 2)
        sizer_11.Add(self.runner_number, 0, wx.ALL, 2)
        sizer_11.Add((20, 10), 0, 0, 0)
        sizer_11.Add(self.label_6, 0, wx.ALL, 2)
        sizer_11.Add(self.runner_category, 0, wx.ALL, 2)
        sizer_11.Add((20, 10), 0, 0, 0)
        label_20_copy_1 = wx.StaticText(self, wx.ID_ANY, "Runner:")
        sizer_11.Add(label_20_copy_1, 0, wx.ALL, 2)
        sizer_11.Add(self.runner_name, 0, wx.ALL, 2)
        sizer_11.Add((20, 10), 0, 0, 0)
        label_22_copy = wx.StaticText(self, wx.ID_ANY, "Team:")
        sizer_11.Add(label_22_copy, 0, wx.ALL, 2)
        sizer_11.Add(self.runner_team, 0, wx.ALL, 2)
        sizer_11.Add((20, 10), 0, 0, 0)
        label_24_copy = wx.StaticText(self, wx.ID_ANY, "SI-Card:")
        sizer_11.Add(label_24_copy, 0, wx.ALL, 2)
        sizer_11.Add(self.runner_sicard, 0, wx.ALL, 2)
        sizer_15.Add(sizer_11, 1, wx.ALL | wx.EXPAND, 5)
        label_4_copy = wx.StaticText(self, wx.ID_ANY, "Run Validation:")
        sizer_17.Add(label_4_copy, 0, wx.ALL, 2)
        sizer_17.Add(self.run_validation, 0, wx.ALL, 2)
        sizer_17.Add((10, 10), 1, 0, 0)
        label_6_copy_1 = wx.StaticText(self, wx.ID_ANY, "Team Validation:")
        sizer_17.Add(label_6_copy_1, 0, wx.ALL, 2)
        sizer_17.Add(self.team_validation, 0, wx.ALL, 2)
        sizer_17.Add((10, 10), 1, 0, 0)
        label_6_copy_copy = wx.StaticText(self, wx.ID_ANY, "Score:")
        sizer_17.Add(label_6_copy_copy, 0, wx.ALL, 2)
        sizer_17.Add(self.run_score, 0, wx.ALL, 2)
        sizer_17.Add((10, 10), 1, 0, 0)
        label_6_copy_copy_copy = wx.StaticText(self, wx.ID_ANY, "Team Score:")
        sizer_17.Add(label_6_copy_copy_copy, 0, wx.ALL, 2)
        sizer_17.Add(self.team_score, 0, wx.ALL, 2)
        sizer_15.Add(sizer_17, 1, wx.ALL | wx.EXPAND, 5)
        sizer_12.Add(sizer_15, 1, wx.EXPAND, 0)
        sizer_18.Add(self.label_8, 0, wx.ALL, 2)
        label_24_copy_copy = wx.StaticText(self, wx.ID_ANY, "Run ID:")
        sizer_18.Add(label_24_copy_copy, 0, wx.ALL, 2)
        sizer_18.Add(self.course, 0, wx.ALL, 2)
        sizer_18.Add(self.run_id, 0, wx.ALL, 2)
        sizer_18.Add(self.label_5_copy, 0, wx.ALL, 2)
        sizer_18.Add(self.label_7_copy_2, 0, wx.ALL, 2)
        sizer_18.Add(self.clear_time, 0, wx.ALL, 2)
        sizer_18.Add(self.check_time, 0, wx.ALL, 2)
        sizer_18.Add(self.label_7_copy_copy, 0, wx.ALL, 2)
        sizer_18.Add(self.label_7_copy_1_copy, 0, wx.ALL, 2)
        sizer_18.Add(self.start_time, 0, wx.ALL, 2)
        sizer_18.Add(self.finish_time, 0, wx.ALL, 2)
        sizer_14.Add(sizer_18, 0, wx.EXPAND, 0)
        sizer_14.Add((20, 20), 0, 0, 0)
        sizer_14.Add(self.punches_grid, 1, wx.EXPAND, 0)
        sizer_12.Add(sizer_14, 1, wx.ALL | wx.EXPAND, 5)
        sizer_3.Add(sizer_12, 1, wx.EXPAND, 0)
        self.SetSizer(sizer_3)
        sizer_3.Fit(self)
        # end wxGlade

    def update(self, observable, event):
        
        try:
            busy = wx.BusyCursor()
        
            # Disable Event handling while updating
            self.SetEvtHandlerEnabled(False)
        
            if type(observable) == RunEditor and event == 'run':
                self.UpdateRun()

                self.runner_number.SetLabel(self.editor.runner_number)
                self.runner_category.SetLabel(self.editor.runner_category)
                self.runner_name.SetLabel(self.editor.runner_name)
                self.runner_team.SetLabel(self.editor.runner_team)

                self.start_time.SetLabel(self.editor.run_start_time[11:])
                self.finish_time.SetLabel(self.editor.run_finish_time[11:])
                self.course.SetLabel(self.editor.run_course)
                
                if (self.editor.has_runner() == False
                    or self.editor.has_course() == False):
                    # change to edit run page
                    self.GetParent().SetSelection(0)

            elif type(observable) == RunEditor and event == 'reader':
                if (self.GetGrandParent().notebook.GetCurrentPage() == self and
                    observable.sicard is not None):
                    try:
                        observable.load_run_from_card()
                    except (SIReaderException, SIReaderTimeout, SIReaderCardChanged), msg:
                        self.GetGrandParent().ErrorDialog(str(msg), 'Error communicating to the SI-Reader')
                    else:
                        if (self.print_checkbox.GetValue() and
                            self.GetParent().GetCurrentPage() == self):
                            # the current page might change if the run is not complete
                            observable.print_run()
                    
            elif type(observable) == RunEditor and event == 'progress':
                p = observable.progress
                self.progress_bar.SetValue(p[0])
                self.progress_text.SetLabel(p[1])
                wx.Yield()
            
        finally:
            # Enable Event handling after updating
            self.SetEvtHandlerEnabled(True)
            
            # delete the busy cursor even if an exception occurs
            del busy

# end of class ReadoutRunPanel


if __name__ == "__main__":
    app = wx.PySimpleApp(0)
    wx.InitAllImageHandlers()
    main_frame = RunEditorFrame(None, -1, "")
    app.SetTopWindow(main_frame)
    main_frame.Show()

    # Connect SI-Reader
    try:
        main_frame.editor.connect_reader()
    except RunEditorException, e:
        main_frame.ErrorDialog(e.message, "Error Connecting SI-Reader")

    app.MainLoop()
